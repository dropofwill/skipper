<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="$views/css/image.css">
		<link rel="stylesheet" href="$views/css/list.css">
		<link rel="stylesheet" href="$views/css/buttons.css">
		<link rel="stylesheet" href="css/main.css">
		<link rel="stylesheet" href="css/github.css">
		<script src="js/jq.js"></script>
	</head>
	<body>
		<div id="wrapper">
			<div id="index" class="section">
			<h1>Skipper</h1>
			

			<div id="html"></div>

			<div class="html-snippet" data-container="html">
				<div id="currently-playing"></div>
			</div>

			<div class="html-snippet" data-container="html">
				<div id="drop-box">Drag and drop a playlist here</div>
			</div>

			<div class="html-snippet" data-container="html">
				<div id="playlist-player"></div>
				<span id="timer"></span>
			</div>

			<script type="script/snippet" data-container="js">
				require(['$api/models', '$views/list#List'], function(models, List) {

					var a_counter = 0,
						current_duration;

					// Handle drops
					var dropBox = document.querySelector('#drop-box');
					var nowPlaying = document.getElementById('currently-playing');
					var positionTimer = document.getElementById('timer');

					function updateStatus(track) {
						if (track == null) {
							nowPlaying.innerHTML = "No track currently playing."
						} else {
							nowPlaying.innerHTML = "<b>" + track.name + " (" + track.duration/1000 + " sec.)</b> is currently playing";
						}
					}

					function updateTimer(position) {
						console.log(position);
					}

					// update on load
					models.player.load('track').done(function(p) {
						updateStatus(p.track);
						current_duration = p.track.duration;
					});

					// update on change
					models.player.addEventListener('change', function(p) {
						updateStatus(p.data.track);
						current_duration = p.data.track.duration;
					});

					dropBox.addEventListener('dragstart', function(e){
						e.dataTransfer.setData('text/html', this.innerHTML);
						e.dataTransfer.effectAllowed = 'copy';
					}, false);

					dropBox.addEventListener('dragenter', function(e){
						e.preventDefault();
						e.dataTransfer.dropEffect = 'copy';
						this.classList.add('over');
					}, false);

					dropBox.addEventListener('dragover', function(e){
						e.preventDefault();
						e.dataTransfer.dropEffect = 'copy';
						return false;
					}, false);

					dropBox.addEventListener('dragleave', function(e){
						e.preventDefault();
						this.classList.remove('over');
					}, false);

					dropBox.addEventListener('drop', function(e){
						e.preventDefault();
						
						a_counter+=1;
						$('#playlist-player div').not("[data-connected-lists-index=a_counter]").addClass("hide");
						
						var drop = models.Playlist.fromURI(e.dataTransfer.getData('text'));

						this.classList.remove('over');
						
						var successMessage = document.createElement('p');
						successMessage.innerHTML = 'Playlist successfully dropped: ' + drop.uri;
						this.appendChild(successMessage);


						drop.load('tracks').done(function(tracks) {
							
							// Stuff purely for display purpoeses
							// Using snapshots for playing the songs

							var a_collection = drop.tracks.shuffle();
							//var a_list = List.forCollection(a_collection);
							var a_list = List.forPlaylist(drop);
							console.log(a_list);
							document.getElementById('playlist-player').appendChild(a_list.node);
							a_list.init();

							// SetTimeout is a non-blocking function, so when executed in a loop it isn't paused
							// âˆ´ the loop structure is implemented with a recursive function songLoop which takes
							// the delay as an argument and calls itself until the tracks run out.
							drop.tracks.snapshot()
								.done(
									function(snapshot) {
										var first_track = snapshot.get(0);
										var i = 0;

										playSong( first_track );

										function songLoop( duration ) {
											setTimeout( function () {
												i++;

												if ( i < snapshot.length ) {
													var next_track = snapshot.get(i);
													
													playSong( next_track );

													songLoop( next_track.duration - 3000 );
												}
											}, duration );
										}
										songLoop( first_track.duration - 3000 );
									}
								);
						});
					}, false);

					function playSong( a_track ) {
						models.player.playTrack(a_track);
					}

				});
			</script>


			</div>
		</div>
		<script src="/js/rainbow-custom.min.js"></script>
		<script src="/js/tutorial.js"></script>
	</body>
</html>
